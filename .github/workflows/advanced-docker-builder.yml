name: Advanced Docker Builder with Commit Checkout

on:
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'GitHub ä»“åº“åœ°å€ (ä¾‹å¦‚: owner/repo)'
        required: true
        type: string
      commit_hash:
        description: 'å…·ä½“çš„ commit å“ˆå¸Œå€¼ (ä¾‹å¦‚: 3b98ed31e22cd2893563d4b375c2538c72a2e224)'
        required: true
        type: string
      docker_build_command:
        description: 'Docker æ„å»ºå‘½ä»¤ (ä¾‹å¦‚: docker build -t my-app .)'
        required: true
        type: string
      image_name:
        description: 'æœ€ç»ˆé•œåƒåç§° (ä¾‹å¦‚: my-app)'
        required: true
        type: string
      image_tag:
        description: 'é•œåƒæ ‡ç­¾ (ä¾‹å¦‚: latest, v1.0.0)'
        required: true
        default: 'latest'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_REGISTRY: ${{ secrets.REGISTRY || 'ghcr.io' }}

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      actions: write  # éœ€è¦æ­¤æƒé™æ¥ä¸Šä¼  artifacts

    steps:
    - name: Checkout source repository at specific commit
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository_url }}
        ref: ${{ inputs.commit_hash }}
        path: source-code

    - name: Verify checkout
      run: |
        cd source-code
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "å½“å‰ commit ä¿¡æ¯:"
        git log -1 --oneline
        echo "commit å“ˆå¸ŒéªŒè¯:"
        git rev-parse HEAD

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Execute custom Docker build command
      run: |
        cd source-code
        echo "æ‰§è¡Œ Docker æ„å»ºå‘½ä»¤: ${{ inputs.docker_build_command }}"

        # æ›¿æ¢ç”¨æˆ·è¾“å…¥çš„é•œåƒåç§°ä¸ºå®Œæ•´çš„ GHCR è·¯å¾„
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image_name }}:${{ inputs.image_tag }}"
        BUILD_COMMAND=$(echo "${{ inputs.docker_build_command }}" | sed "s|${{ inputs.image_name }}|${FULL_IMAGE_NAME}|g")

        echo "ä¿®æ”¹åçš„æ„å»ºå‘½ä»¤: $BUILD_COMMAND"
        eval $BUILD_COMMAND

        # éªŒè¯é•œåƒæ˜¯å¦æ„å»ºæˆåŠŸ
        echo "éªŒè¯æœ¬åœ°é•œåƒ:"
        docker images | grep "${{ inputs.image_name }}"

    - name: Push Docker image to GHCR
      run: |
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image_name }}:${{ inputs.image_tag }}"
        echo "æ¨é€é•œåƒåˆ° GHCR: $FULL_IMAGE_NAME"
        docker push $FULL_IMAGE_NAME

    - name: Save Docker image as .tar file
      run: |
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image_name }}:${{ inputs.image_tag }}"
        TAR_FILE_NAME="${{ inputs.image_name }}-${{ inputs.image_tag }}.tar"

        echo "ä¿å­˜é•œåƒä¸º .tar æ–‡ä»¶: $TAR_FILE_NAME"
        docker save -o $TAR_FILE_NAME $FULL_IMAGE_NAME

        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        echo "æ–‡ä»¶å¤§å°:"
        ls -lh $TAR_FILE_NAME

    - name: Upload Docker image .tar file as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.image_name }}-${{ inputs.image_tag }}-docker-image
        path: ${{ inputs.image_name }}-${{ inputs.image_tag }}.tar
        retention-days: 30  # ä¿ç•™30å¤©

    - name: Output final information
      run: |
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image_name }}:${{ inputs.image_tag }}"
        TAR_FILE_NAME="${{ inputs.image_name }}-${{ inputs.image_tag }}.tar"

        echo "ğŸ‰ Docker é•œåƒæ„å»ºå’Œæ‰“åŒ…å®Œæˆ!"
        echo ""
        echo "ğŸ“¦ é•œåƒä¿¡æ¯:"
        echo "  é•œåƒåœ°å€: $FULL_IMAGE_NAME"
        echo "  æ‹‰å–å‘½ä»¤: docker pull $FULL_IMAGE_NAME"
        echo ""
        echo "ğŸ’¾ æ–‡ä»¶ä¿¡æ¯:"
        echo "  .tar æ–‡ä»¶: $TAR_FILE_NAME"
        echo "  ä¸‹è½½ä½ç½®: GitHub Actions é¡µé¢çš„ Artifacts éƒ¨åˆ†"
        echo ""
        echo "ğŸ“‹ åŠ è½½ .tar æ–‡ä»¶çš„å‘½ä»¤:"
        echo "  docker load -i $TAR_FILE_NAME"